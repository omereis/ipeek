<html>
	<head>
		<meta http-equiv="Content-Type" content="text/html; charset=utf-8"/>
		<meta http-equiv="X-UA-Compatible" content="IE=9" >
		<title>NCNR live data</title>
 
        <!-- Reference the theme's stylesheet on the Google CDN -->
        <link href="http://ajax.googleapis.com/ajax/libs/jqueryui/1.7.2/themes/start/jquery-ui.css"
            type="text/css" rel="Stylesheet" />
            
<!--        <style>-->
<!--         body {width:100%; height:100%; overflow:hidden, margin:0}-->
<!--         html {width:100%; height:100%; overflow:hidden}-->
<!--        </style>-->
 
        <!-- Reference jQuery and jQuery UI from the CDN. Remember
           that the order of these two elements is important -->
        <script src="//ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js" type="text/javascript"></script>
<!--        <script src="http://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js"></script>-->
<!--        <script src="http://ajax.googleapis.com/ajax/libs/jqueryui/1.7.2/jquery-ui.min.js"></script>-->
        <script src="//ajax.googleapis.com/ajax/libs/jqueryui/1.8.2/jquery-ui.min.js" type="text/javascript"></script>
<!--		<script type="text/javascript" src="jquery-1.5.1.min.js"></script>-->
<!--        <script type="text/javascript" src="jquery.jqplot.min.js"></script>-->

        <script type="text/javascript" src="http://ncnr.nist.gov/instruments/magik/jqplot/jquery.jqplot.min.js"></script>
        <script type="text/javascript" src="http://ncnr.nist.gov/instruments/magik/jqplot/plugins/jqplot.canvasTextRenderer.min.js"></script>
        <script type="text/javascript" src="http://ncnr.nist.gov/instruments/magik/jqplot/plugins/jqplot.canvasAxisLabelRenderer.min.js"></script>
        <script type="text/javascript" src="http://ncnr.nist.gov/instruments/magik/jqplot/plugins/jqplot.canvasAxisTickRenderer.min.js"></script>
        <script type="text/javascript" src="http://ncnr.nist.gov/instruments/magik/jqplot/plugins/jqplot.cursor.min.js"></script>
        
        <script type="text/javascript" src="http://ncnr.nist.gov/instruments/magik/jqplot.science/plugins/jqplot.errorbarRenderer.js"></script>
        <script type="text/javascript" src="http://ncnr.nist.gov/instruments/magik/jqplot.science/plugins/jqplot.InteractiveLegend.js"></script>
        <script type="text/javascript" src="http://ncnr.nist.gov/instruments/magik/jqplot.science/plugins/jqplot.FixedAspect.js"></script>
        <script type="text/javascript" src="http://ncnr.nist.gov/instruments/magik/jqplot.science/plugins/jqplot.GracefulAxisRenderer.js"></script>
        <script type="text/javascript" src="http://ncnr.nist.gov/instruments/magik/jqplot.science/plugins/jqplot.touchEvents.js"></script>
        <script type="text/javascript" src="http://ncnr.nist.gov/instruments/magik/jqplot.science/plugins/jqplot.heatmapRenderer.js"></script>
        <script type="text/javascript" src="http://ncnr.nist.gov/instruments/magik/jqplot.science/plugins/jqplot.colorbarRenderer.js"></script>
        
        <script type="text/javascript" src="http://ncnr.nist.gov/instruments/magik/jqplot.science/interactors/interactors.js"></script>
        <script type="text/javascript" src="http://ncnr.nist.gov/instruments/magik/jqplot.science/interactors/interactors_plugin_base.js"></script>
        <script type="text/javascript" src="http://ncnr.nist.gov/instruments/magik/jqplot.science/interactors/rectangle_interactor_plugin.js"></script>

        <script type="text/javascript" src="plotting_api2.js"></script>
        <script src="geturlvars.js"></script>
        

		<!-- JQPLOT -->
		<script type="text/javascript">
		    var refreshtime = 60; // 1 minute refresh rate
            var refreshtimer = null;
		    COLS = 4;
    		INSTRUMENTS = [];
    		INSTRUMENT_NAMES = {'CGD': 'MAGIK', 'NGD': 'PBR', 'NG2':'HFBS', 'BT4':'FANS', 'NG7':'Reflectometer'}
    		current_instr = null;
    		plots = {};
    		colorbars = {};
    		
    		function onshow() {
              if (refreshtimer == null) 
                refreshtimer = setInterval("loadData(INSTRUMENTS);", refreshtime*1000);
            }
            function onhide() {
              if (refreshtimer != null) {
                clearInterval(refreshtimer);
                refreshtimer = null;
              }
            }
            
            function createTable(target, cols, numCells) {
                // create a table with numCells in the target
                var table = $('<table />', {'id': 'instruments'});
                $('#'+target).append(table);
                var cells = 0;
                for (var r=0; cells < numCells; r++) {
                    var row = $('<tr />');
                    table.append(row);
                    for (var c=0; c<cols && cells < numCells; c++) {
                        var cell = $('<td />', {'class': 'plotcell', 'id': 'cell' + (cells+1).toFixed()});
                        cell.append($('<div />', {'id': 'plot'+(cells+1).toFixed(), 'class': 'plotdiv'}));
                        var transform = $('<label />').text('log').append($('<input />', {'type': 'checkbox', 'class': 'transform'}));
                        cell.append(transform);
                        cell.append($('<span />', {'id': 'eta' + (cells+1).toFixed()}));
                        cell.append($('<div />', {'class': 'instrument-name ui-state-default'}));
                        row.append(cell);
                        cells++;
                    }
                }
            }
            
		    window.onresize = function() {
		        //$('.plotgrid').width(($(window).innerWidth() / COLS - 75).toFixed() + 'px');
		        var new_width = (1.0/COLS * 100);
		        $('.plotcell').width(new_width.toFixed() + '%')
		        $('.plotcell div').width(($('.plotcell').width() - 10).toFixed() + 'px');
		        $('.plotcell .plotdiv').height(($(window).innerHeight() - 250).toFixed() + 'px');
		        for (var p in plots) {
		            plots[p].replot();
		        }
		    }
		    window.onload = function() {
		        //$.ajaxSetup({ cache: false });
		        debug=false;
		        current_instr = jQuery.getUrlVar('instrument');
		        INSTRUMENTS = [current_instr];
		        createTable('content_table', 1, 1);
		        $('.transform').change(updateTransform);        
		        loadData();
		        onshow();
		        
		        //loadData(INSTRUMENTS);
		        window.onresize();
		    }
		    
		    function loadData(instruments) {
		        var instruments = instruments || INSTRUMENTS;
		        for (var i=0; i<instruments.length; i++) {
		            var instr = instruments[i];
		            var noCache = new Date().getTime();
		            $.getJSON("test_jqpeek/" + instr + "/live_data.json", { "noCache": noCache }, showData(instr));
		        }
		    }
		    
		    /*function updateTransform(ev) {
		        var plottarget = $(this).parent().parent().find('.jqplot-target')[0].id;
		        for (var p in plots) {
		            if (plots[p].targetId == ('#' + plottarget)) {
		                var noCache = new Date().getTime();
		                $.getJSON("test_jqpeek/" + p + "/live_data.json", { "noCache": noCache }, showData(p));
		                break;
		            }
		        }
		    }*/
		    
		    function updateTransform(ev) {
		        var logselected = ev.target.checked;
                var transform = logselected? 'log' : 'lin';
                var next_target = current_instr;
                //Y_TRANSFORM[current_instr] = transform;
                //if (localStorage && localStorage != null) {
                //    localStorage['Y_TRANSFORM'] = JSON.stringify(Y_TRANSFORM);
                //}
                //if (plots[current_target] && plots[current_target].setTransform) {plots[current_target].setTransform(transform)};
                if (plots[next_target] && plots[next_target].setTransform) {plots[next_target].setTransform(transform)};
                if (colorbars[next_target]) { colorbars[next_target].plugins._interactor.zoomMax() };
		    }
		    
		    function showData(instr) {
		        function handler(datalist) {
		            var data = datalist[0];
		            $.extend(true, data.options, {axes: {
	                    xaxis: {renderer: $.jqplot.GracefulAxisRenderer},
	                    yaxis: {renderer: $.jqplot.GracefulAxisRenderer}
	                    }
	                });
                    //var instr = data.metadata.instrument;
                    var i = INSTRUMENTS.indexOf(instr);
                    if (i > -1) {
                        var cell_target = 'cell' + (i+1).toFixed();
	                    var plot_target = 'plot' + (i+1).toFixed();
	                    var eta_target = 'eta' + (i+1).toFixed();
	                    var logselected = $('#' + cell_target).find('input')[0].checked;
	                    var transform = logselected? 'log' : 'lin';
	                    
	                    //var data = liveData[instr][0];
	                    if (instr in plots && plots[instr].destroy) {
	                        plots[instr].destroy();
	                    }
	                    //plots[instr] = plottingAPI(data, plot_target);
	                    if (data.type == '1d') {
	                        plots[instr] = render1dplot(null, data, transform, plot_target);
	                        $('#' + eta_target).html(make_metadata_table(data.metadata));
	                    } else if (data.type == '2d') {
                            //plots[instr] = plottingAPI(datalist, plot_target);
                            $('#' + plot_target).empty();
                            var plotbox = $('<div />', {class:'ui-widget-content', style:"display: block; width: 100%; height: 100%;", id:"plotbox"});
                            $('#' + plot_target).append(plotbox)
                            plotbox.append($('<div />', {
                                style:"display: inline-block; left: 0; top: 0; width:"+(plotbox.width()-150).toFixed()+"px; height: 100%;", 
                                id: plot_target + "_plot"}));
                            plotbox.append($('<div />', {style:"display: inline-block; width: 100px; height: 100%;", id:plot_target + "_colorbar"}));
                            var plot = renderImageData2(data, transform, plot_target + "_plot");
                            var cbar_options = {
                                axes: {y2axis: {renderer: $.jqplot.GracefulAxisRenderer, tickOptions: {fontSize: 18}, labelOptions: {fontSize: 18}}}
            	            }
                            var colorbar = renderImageColorbar2(plot.series[0], plot_target + '_colorbar');
                            plots[plot_target] = plot;
                            colorbars[plot_target] = colorbar;
                            plot.replot(); // for aspect ratio plugin!
                            colorbar.plugins._interactor.zoomMax(); // for scale!
                            //plots[plot_target] = plottingAPI(datalist, plot_target);
                            if (data.metadata) {
                                $('#' + eta_target).html(make_metadata_table(data.metadata));
                            }
                        }
                        /*
	                    } else if (data.type == '2d') {
	                        //plots[instr] = plottingAPI(datalist, plot_target);
	                        plots[instr] = plottingAPI(datalist, plot_target);
	                        $('#' + eta_target).html(make_metadata_table(data.metadata));
	                    }
	                    */
	                    var instr_link = $('<a />', {'href': 'singleplotwindow.html?instrument=' + instr});
	                    var instr_name = instr;
	                    if (instr in INSTRUMENT_NAMES) { instr_name += ": " + INSTRUMENT_NAMES[instr]; }
	                    instr_link.html(instr_name);
	                    $('.instrument-name', '#' + cell_target).empty()
	                    $('.instrument-name', '#' + cell_target).append(instr_link)
	                }
	            }
	            return handler
	        }  

		    function make_metadata_table(metadata, numcols) {
                var numcols = numcols || 4;
                var new_table = document.createElement('table');
                var keys = Object.keys(metadata);
                var num_items = keys.length;
                for (var i=0; i<num_items; i+=numcols) {
                    var row = new_table.insertRow(-1);
                    for (var j=0; j<numcols; j++) {
                        var index = i + j;
                        if (index >= num_items) { break; }
                        var key = keys[index];
                        
                        var value = metadata[key];
                        var label = row.insertCell(-1);
                        label.setAttribute('class', 'metadata-label');
                        label.innerHTML=key;
                        var entry = row.insertCell(-1);
                        entry.setAttribute('class', 'metadata-value');
                        entry.innerHTML=value;
                    }
                }
                return new_table;
            }
		</script>
		<style>
		    #instruments { 
		        width: 100%;
		    }
		    .instrument-name { 
		        text-align: center;
		        font-family: "Georgia", serif;
		        font-weight: bold;
		    }
		                       
		    #instruments tr { margin-bottom: 30px; }
		    div { 
		        user-select: none; 
		        -webkit-user-select: none; 
		        -moz-user-select: none;
		    }
		    .metadata-label {color: red}
		    .slidingDiv {
                background-color: #99CCFF;
                padding:20px;
                margin-top:10px;
                border-bottom:5px solid #3399FF;
            }
             
            .show_hide {
                display:none;
            }
            .jqplot-table-legend-swatch {
			    width: 10;
			    height: 10;
			}
			.jqplot-series-shadowCanvas {
			    display: none;
			}
		</style>
		 <style type="text/css">
		#leftSide {
          float: left;
          width: 50%;
        }
         
        #rightSide {
          float: left;
          width: 50%;
        }
    </style>
	</head>
	<body id="woot">
	<?php include("/var/www/include/navigation.inc"); ?>
    <?php include("/var/www/include/utility.inc"); ?>

	    <div id="content_table"></div>
	    
	<div class="footer">
    <div style="float:left;"><p>Brian B. Maranville(<a href="mailto:brian.maranville@nist.gov">brian.maranville@nist.gov</a>)</p></div>
    <div style="float:right;"><p><? lastmod(); ?></p></div>
    </div>

	</body>
</html>
